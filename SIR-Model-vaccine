#include <stdio.h>
#include <stdlib.h>
#include <math.h>

// funktionsprototyper
int sirModel(float S0, float I0, float R0);

// startværdier vi bruger og løbende vil ændre på
float S0 = 500.0f;
float I0 = 2.0f;
float R0 = 0.0f;

float betaYAY = 0.3247f;
float gammaYAY = 0.143f;

// main funktion
int main(void)
{
    // kalder sir model function med startværdier
    sirModel(S0, I0, R0);

    return 0;
}

// funktion der plotter en sir model ud fra 3 givne startværdier
int sirModel(float S_init, float I_init, float R_init) // kun til windows indtilvidere
{
    // laver en pipe til gnuplot.exe
    char gnuplot_path[512];
    printf("Enter full path to gnuplot.exe: ");
    scanf(" %[^\n]", gnuplot_path);

    // Vaccination parameters from user
    int mode = 1;
    printf("Vaccination mode (1 = all-or-nothing S->R, 2 = leaky S->V with reduced susceptibility): ");
    if (scanf("%d", &mode) != 1) mode = 1;

    float v = 0.0f; // per-capita vaccination rate (fraction of susceptibles vaccinated per day)
    printf("Vaccination rate v (fraction of susceptibles vaccinated per day, e.g. 0.01): ");
    if (scanf("%f", &v) != 1) v = 0.0f;

    float e = 1.0f; // vaccine efficacy (0..1)
    printf("Vaccine efficacy e (0-1, e.g. 0.9): ");
    if (scanf("%f", &e) != 1) e = 1.0f;
    if (e < 0.0f) e = 0.0f;
    if (e > 1.0f) e = 1.0f;

    int days = 100;
    printf("Number of days to simulate: ");
    if (scanf("%d", &days) != 1) days = 100;
    if (days < 1) days = 1;

    // prepare gnuplot command and open pipe
    char command[600];
    sprintf(command, "\"%s\" -persistent", gnuplot_path);
    FILE *pipe = _popen(command, "w");
    if (!pipe)
    {
        perror("_popen failed");
        return 1;
    }

    // open data file
    const char *file_name = "data_file.txt";
    FILE *file = fopen(file_name, "w");
    if (file == NULL)
    {
        printf("could not open the file %s\n", file_name);
        _pclose(pipe);
        return 1;
    }

    // initialize compartments from inputs
    float S = S_init;
    float I = I_init;
    float R = R_init;
    float V = 0.0f; // vaccinated compartment used in leaky model
    float dt = 1.0f;

    // make sure initial totals are consistent
    float N = S + I + R + V;
    if (N <= 0.0f) N = 1.0f;

    // write header comment to file (optional)
    // fprintf(file, "# day S I R V\n");

    for (int n = 0; n < days; n++)
    {
        // recompute population size (S+I+R+V) for denominators
        N = S + I + R + V;
        if (N <= 0.0f) N = 1.0f;

        float dSdT = 0.0f;
        float dVdT = 0.0f;
        float dIdT = 0.0f;
        float dRdt = 0.0f;

        if (mode == 1)
        {
            // All-or-nothing vaccine: fraction e of vaccinated become fully immune (S -> R)
            // Vaccination happening at rate v per susceptible; only e*v*S gives immunity
            dSdT = -betaYAY * S * I / N - e * v * S;
            dIdT = betaYAY * S * I / N - gammaYAY * I;
            dRdt = gammaYAY * I + e * v * S;
            dVdT = 0.0f; // not used in this mode
        }
        else
        {
            // Leaky vaccine: vaccinated individuals go to V at rate v*S,
            // but have reduced susceptibility sigma = 1 - e
            float sigma = 1.0f - e; // remaining susceptibility
            dSdT = -betaYAY * S * I / N - v * S;
            dVdT = v * S - betaYAY * sigma * V * I / N;
            dIdT = betaYAY * S * I / N + betaYAY * sigma * V * I / N - gammaYAY * I;
            dRdt = gammaYAY * I;
        }

        // Euler update
        S += dSdT * dt;
        V += dVdT * dt;
        I += dIdT * dt;
        R += dRdt * dt;

        // prevent small negative numerical artifacts
        if (S < 0.0f) S = 0.0f;
        if (V < 0.0f) V = 0.0f;
        if (I < 0.0f) I = 0.0f;
        if (R < 0.0f) R = 0.0f;

        // recompute N
        N = S + I + R + V;

        // print to terminal and write to file (five columns: day S I R V)
        printf("Day %d: S = %.2f, I = %.2f, R = %.2f, V = %.2f\n", n, S, I, R, V);
        fprintf(file, "%d %f %f %f %f\n", n, S, I, R, V);
    }

    // close data file
    fclose(file);

    // gnuplot commands that make headers and labels and plot 4 series
    fprintf(pipe, "set title 'SIR Model Simulation (with vaccination)'\n");
    fprintf(pipe, "set xlabel 'Days'\n");
    fprintf(pipe, "set ylabel 'Population'\n");
    fprintf(pipe, "plot '%s' using 1:2 with lines lw 2 title 'Susceptible', \\\n", file_name);
    fprintf(pipe, "     '%s' using 1:5 with lines lw 2 title 'Vaccinated', \\\n", file_name);
    fprintf(pipe, "     '%s' using 1:3 with lines lw 2 title 'Infected', \\\n", file_name);
    fprintf(pipe, "     '%s' using 1:4 with lines lw 2 title 'Recovered'\n", file_name);
    fflush(pipe);
    _pclose(pipe);

    return 0;
